name: Beta Release (Unsigned Multi-Platform)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0-beta.1)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: true
        type: boolean

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.setup.outputs.version }}
    steps:
      - name: Setup version
        id: setup
        run: echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

  build-windows:
    needs: setup
    runs-on: windows-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: Run tests
        run: npm run test:ci
        env:
          CI: true

      - name: Build Windows (unsigned)
        run: npm run build && npx cross-env CSC_IDENTITY_AUTO_DISCOVERY=false electron-builder --config electron-builder-unsigned.json --win --publish=never
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-unsigned
          path: dist-release/*.exe

  build-macos:
    needs: setup
    runs-on: macos-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: Run tests
        run: npm run test:ci
        env:
          CI: true

      - name: Build macOS (unsigned)
        run: npm run build && npx cross-env CSC_IDENTITY_AUTO_DISCOVERY=false electron-builder --config electron-builder-unsigned.json --mac --publish=never
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-unsigned
          path: dist-release/*

  build-linux:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --legacy-peer-deps --no-audit --no-fund

      - name: Run tests
        run: npm run test:ci
        env:
          CI: true

      - name: Build Linux (unsigned)
        run: npm run build && npx cross-env CSC_IDENTITY_AUTO_DISCOVERY=false electron-builder --config electron-builder-unsigned.json --linux --publish=never
        env:
          NODE_OPTIONS: --max-old-space-size=8192

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-unsigned
          path: dist-release/*

  create-release:
    needs: [setup, build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.setup.outputs.version }}
          name: ${{ needs.setup.outputs.version }}
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            windows-unsigned/*
            macos-unsigned/*
            linux-unsigned/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-tag-and-setup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Invalid version format. Expected: v1.0.0 or v1.0.0-beta.1"
            exit 1
          fi

      - name: Delete existing release if it exists
        run: |
          # Delete existing GitHub release if it exists
          gh release delete ${{ github.event.inputs.version }} --yes || echo "Release doesn't exist"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create and push tag
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Delete existing tag if it exists (locally and remotely)
          git tag -d ${{ github.event.inputs.version }} || echo "Local tag doesn't exist"
          git push origin :refs/tags/${{ github.event.inputs.version }} || echo "Remote tag doesn't exist"
          
          # Create new tag
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  windows-release:
    needs: create-tag-and-setup
    runs-on: windows-latest
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.version }}
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Clean npm cache
        run: npm cache clean --force

      - name: Install dependencies
        run: |
          npm ci --no-audit --no-fund --legacy-peer-deps --silent
          npm ls --depth=0 || true
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          NPM_CONFIG_LOGLEVEL: "error"

      - name: Update version in source files
        run: |
          # Get version without 'v' prefix
          $version = "${{ github.event.inputs.version }}" -replace '^v', ''
          
          # Update package.json only if version is different
          $currentVersion = (Get-Content "package.json" | ConvertFrom-Json).version
          if ($currentVersion -ne $version) {
            npm version --no-git-tag-version $version
          } else {
            Write-Host "Package.json already has version $version"
          }
          
          # Update src/shared/version.ts
          if (Test-Path "src/shared/version.ts") {
            (Get-Content "src/shared/version.ts") -replace "export const VERSION = .*", "export const VERSION = '$version';" | Set-Content "src/shared/version.ts"
            Write-Host "Updated version.ts to version $version"
          }

      - name: Set prerelease flag
        if: ${{ github.event.inputs.prerelease == 'true' }}
        run: |
          node -e "
            const pkg = require('./package.json');
            if (!pkg.build) pkg.build = {};
            if (!pkg.build.publish) pkg.build.publish = {};
            pkg.build.publish.releaseType = 'prerelease';
            require('fs').writeFileSync('./package.json', JSON.stringify(pkg, null, 2) + '\n');
          "

      - name: Build and release (unsigned)
        run: npm run release:local:unsigned
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_OPTIONS: "--max-old-space-size=8192"
          
      - name: Upload release artifacts
        run: |
          # Upload all artifacts from dist-release directory
          gh release upload ${{ github.event.inputs.version }} dist-release/*.exe --clobber
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload build artifacts (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-windows-${{ github.run_number }}
          path: |
            dist/
            dist-release/
            *.log
            npm-debug.log*
            .npm/_logs/
