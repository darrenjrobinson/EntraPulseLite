#!/bin/sh
# EntraPulse Lite Pre-commit Security Hook

echo "üîç Running pre-commit security checks..."

# Check for common secret patterns (excluding known safe GUIDs)
SECRET_PATTERNS="client_secret|api_key|secret_key|access_token|private_key|password.*=|pwd.*=|connectionString|connection_string"

# Get staged files (excluding lock files and other common false positives)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|tsx|jsx|json|md|txt|env)$' | grep -v -E '(package-lock\.json|yarn\.lock|pnpm-lock\.yaml|\.git/|node_modules/)')

if [ -n "$STAGED_FILES" ]; then
    echo "Checking staged files for secrets..."
    
    # Check for potential secrets
    SECRET_FOUND=$(echo "$STAGED_FILES" | xargs grep -l -i -E "$SECRET_PATTERNS" 2>/dev/null || true)
    
    if [ -n "$SECRET_FOUND" ]; then
        echo "‚ùå Potential secrets found in staged files:"
        echo "$SECRET_FOUND"
        echo ""
        echo "Please remove any hardcoded secrets before committing."
        echo "Use environment variables or Azure Key Vault instead."
        exit 1
    fi
    
    # Check for suspicious GUIDs (but allow known safe ones)
    GUID_FILES=$(echo "$STAGED_FILES" | xargs grep -l -E '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' 2>/dev/null || true)
    
    if [ -n "$GUID_FILES" ]; then
        # Filter out known safe GUIDs
        SUSPICIOUS_GUIDS=$(echo "$STAGED_FILES" | xargs grep -E '[a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12}' 2>/dev/null | grep -v -E '14d82eec-204b-4c2f-b7e8-296a70dab67e|1950a258-227b-4e31-a9cf-717495945fc2|04b07795-8ddb-461a-bbee-02f9e1bf7b46' || true)
        
        if [ -n "$SUSPICIOUS_GUIDS" ]; then
            echo "‚ö†Ô∏è  Found GUID patterns in staged files:"
            echo "$SUSPICIOUS_GUIDS"
            echo ""
            echo "Please verify these are not real client IDs or secrets."
            echo "Use placeholder values in documentation and examples."
            echo ""
            echo "Known safe GUIDs (Microsoft well-known client IDs) are allowed."
        fi
    fi
    
    # Check for .env files
    ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env' || true)
    if [ -n "$ENV_FILES" ]; then
        echo "‚ùå Environment files found in staged changes:"
        echo "$ENV_FILES"
        echo ""
        echo "Environment files should never be committed!"
        echo "Add them to .gitignore and use .env.example instead."
        exit 1
    fi
fi

echo "‚úÖ Pre-commit security checks passed"
exit 0