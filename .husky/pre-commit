#!/bin/sh
# EntraPulse Lite Pre-commit Security Hook

echo "üîç Running pre-commit security checks..."

# Get staged files (excluding lock files and other common false positives)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|js|tsx|jsx|json|md|txt)$' | grep -v -E '(package-lock\.json|yarn\.lock|pnpm-lock\.yaml|\.git/|node_modules/)')

if [ -n "$STAGED_FILES" ]; then
    echo "Checking staged files for secrets..."
    
    # Simple check for obvious secrets (avoiding false positives)
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Look for obvious secret patterns but exclude legitimate code
            if grep -q -E "(client_secret|api_key|secret_key|access_token|private_key|password)\s*[=:]\s*['\"][a-zA-Z0-9]{20,}['\"]" "$file" 2>/dev/null; then
                # Skip if it's obviously test/config code
                if ! grep -q -E "(config\.|process\.env\.|your-.*-key|test-.*-key|dummy-|example)" "$file" 2>/dev/null; then
                    echo "‚ùå Potential secrets found in: $file"
                    echo "Please verify no real secrets are committed."
                fi
            fi
        fi
    done
    
    # Check for .env files (should never be committed)
    ENV_FILES=$(echo "$STAGED_FILES" | grep -E '\.env$' || true)
    if [ -n "$ENV_FILES" ]; then
        echo "‚ùå Environment files found in staged changes:"
        echo "$ENV_FILES"
        echo ""
        echo "Environment files should never be committed!"
        exit 1
    fi
fi

echo "‚úÖ Pre-commit security checks passed"
exit 0